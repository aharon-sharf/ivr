---
- name: Deploy Node.js Worker for Asterisk Integration
  hosts: asterisk
  become: yes
  vars:
    nodejs_worker_dir: /opt/asterisk-worker
    nodejs_worker_user: asterisk
    nodejs_worker_service: asterisk-worker

  tasks:
    - name: Install Node.js and npm
      dnf:
        name:
          - nodejs24
          - npm
        state: present

    - name: Create Node.js worker directory
      file:
        path: "{{ nodejs_worker_dir }}"
        state: directory
        owner: "{{ nodejs_worker_user }}"
        group: "{{ nodejs_worker_user }}"
        mode: '0755'

    - name: Check if worker package exists
      stat:
        path: "{{ nodejs_worker_package | default('files/asterisk-worker.tar.gz') }}"
      register: worker_package_stat
      delegate_to: localhost

    - name: Extract Node.js worker package
      unarchive:
        src: "{{ nodejs_worker_package | default('files/asterisk-worker.tar.gz') }}"
        dest: "{{ nodejs_worker_dir }}"
        owner: "{{ nodejs_worker_user }}"
        group: "{{ nodejs_worker_user }}"
        mode: '0644'
      when: worker_package_stat.stat.exists

    - name: Verify Node.js installation
      command: /usr/bin/node --version
      register: node_version
      changed_when: false

    - name: Display Node.js version
      debug:
        msg: "Node.js version: {{ node_version.stdout }}"

    - name: Install Node.js dependencies
      npm:
        path: "{{ nodejs_worker_dir }}"
        state: present
        omit: dev
        executable: /usr/bin/npm
      become_user: "{{ nodejs_worker_user }}"
      when: worker_package_stat.stat.exists

    - name: Create systemd service file for Node.js worker
      copy:
        src: "{{ nodejs_worker_dir }}/asterisk-worker.service"
        dest: /etc/systemd/system/asterisk-worker.service
        remote_src: yes
        owner: root
        group: root
        mode: '0644'
      when: worker_package_stat.stat.exists
      notify: reload systemd

    - name: Create fallback systemd service if package not found
      copy:
        dest: /etc/systemd/system/asterisk-worker.service
        content: |
          [Unit]
          Description=Asterisk Node.js Worker (Placeholder)
          After=network.target asterisk.service
          
          [Service]
          Type=simple
          User=asterisk
          WorkingDirectory=/opt/asterisk-worker
          ExecStart=/bin/echo "Node.js worker not deployed yet"
          Restart=no
          
          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'
      when: not worker_package_stat.stat.exists
      notify: reload systemd

    - name: Enable and start Node.js worker service
      systemd:
        name: "{{ nodejs_worker_service }}"
        enabled: yes
        state: started
        daemon_reload: yes
      when: worker_package_stat.stat.exists

    - name: Create log directory for Node.js worker
      file:
        path: /var/log/asterisk-worker
        state: directory
        owner: "{{ nodejs_worker_user }}"
        group: "{{ nodejs_worker_user }}"
        mode: '0755'

    - name: Configure logrotate for Node.js worker
      copy:
        dest: /etc/logrotate.d/asterisk-worker
        content: |
          /var/log/asterisk-worker/*.log {
              daily
              missingok
              rotate 7
              compress
              delaycompress
              notifempty
              copytruncate
              su asterisk asterisk
          }
        owner: root
        group: root
        mode: '0644'

    - name: Display Node.js worker status
      systemd:
        name: "{{ nodejs_worker_service }}"
      register: worker_status

    - name: Show worker service status
      debug:
        msg: "Node.js Worker Status: {{ worker_status.status.ActiveState }}"

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes