---
- name: Install and Configure Asterisk Telephony Server
  hosts: asterisk
  become: yes
  vars_files:
    - group_vars/asterisk.yml

  tasks:
    - name: Update system packages
      dnf:
        name: '*'
        state: latest
        update_cache: yes

    - name: Install development tools and dependencies
      dnf:
        name:
          - gcc
          - gcc-c++
          - make
          - wget
          - tar
          - bzip2
          - patch
          - libedit-devel
          - libuuid-devel
          - jansson-devel
          - libxml2-devel
          - sqlite-devel
          - openssl-devel
          - ncurses-devel
          - newt-devel
          - kernel-devel
          - kernel-headers
          - libtool
          - autoconf
          - automake
          - git
          - subversion
        state: present

    - name: Download Asterisk source
      get_url:
        url: "https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-{{ asterisk_version }}.tar.gz"
        dest: "/usr/src/asterisk-{{ asterisk_version }}.tar.gz"
        mode: '0644'

    - name: Extract Asterisk source
      unarchive:
        src: "/usr/src/asterisk-{{ asterisk_version }}.tar.gz"
        dest: "/usr/src/"
        remote_src: yes
        creates: "/usr/src/asterisk-{{ asterisk_version }}"

    - name: Install Asterisk prerequisites
      shell: |
        cd /usr/src/asterisk-{{ asterisk_version }}
        contrib/scripts/install_prereq install
      args:
        creates: /usr/src/asterisk-{{ asterisk_version }}/.prereq_installed
      register: prereq_result

    - name: Mark prerequisites as installed
      file:
        path: "/usr/src/asterisk-{{ asterisk_version }}/.prereq_installed"
        state: touch
      when: prereq_result.changed

    - name: Configure Asterisk build
      shell: |
        cd /usr/src/asterisk-{{ asterisk_version }}
        ./configure --with-jansson-bundled --with-pjproject-bundled
      args:
        creates: /usr/src/asterisk-{{ asterisk_version }}/makeopts

    - name: Select Asterisk modules
      shell: |
        cd /usr/src/asterisk-{{ asterisk_version }}
        make menuselect.makeopts
        menuselect/menuselect \
          --enable res_http_websocket \
          --enable res_ari \
          --enable res_ari_applications \
          --enable res_ari_asterisk \
          --enable res_ari_bridges \
          --enable res_ari_channels \
          --enable res_ari_device_states \
          --enable res_ari_endpoints \
          --enable res_ari_events \
          --enable res_ari_mailboxes \
          --enable res_ari_model \
          --enable res_ari_playbacks \
          --enable res_ari_recordings \
          --enable res_ari_sounds \
          --enable chan_pjsip \
          --enable res_pjsip \
          --enable res_pjsip_session \
          menuselect.makeopts
      args:
        creates: /usr/src/asterisk-{{ asterisk_version }}/menuselect.makeopts

    - name: Compile Asterisk
      shell: |
        cd /usr/src/asterisk-{{ asterisk_version }}
        make -j$(nproc)
      args:
        creates: /usr/src/asterisk-{{ asterisk_version }}/main/asterisk

    - name: Install Asterisk
      shell: |
        cd /usr/src/asterisk-{{ asterisk_version }}
        make install
        make samples
      args:
        creates: /usr/sbin/asterisk

    - name: Create Asterisk user
      user:
        name: asterisk
        system: yes
        shell: /bin/false
        home: /var/lib/asterisk
        create_home: no

    - name: Set Asterisk file ownership
      file:
        path: "{{ item }}"
        owner: asterisk
        group: asterisk
        recurse: yes
      loop:
        - /etc/asterisk
        - /var/lib/asterisk
        - /var/log/asterisk
        - /var/spool/asterisk
        - /usr/lib64/asterisk

    - name: Set Asterisk binary ownership
      file:
        path: /usr/sbin/asterisk
        owner: asterisk
        group: asterisk

    - name: Configure Asterisk to run as asterisk user
      lineinfile:
        path: /etc/sysconfig/asterisk
        regexp: '^#?AST_USER='
        line: 'AST_USER="asterisk"'
        create: yes

    - name: Configure Asterisk to run as asterisk group
      lineinfile:
        path: /etc/sysconfig/asterisk
        regexp: '^#?AST_GROUP='
        line: 'AST_GROUP="asterisk"'

    - name: Create Asterisk PID directory
      file:
        path: /var/run/asterisk
        state: directory
        owner: asterisk
        group: asterisk
        mode: '0755'

    - name: Configure Asterisk main configuration
      lineinfile:
        path: /etc/asterisk/asterisk.conf
        regexp: '^astpidfile'
        line: 'astpidfile => /var/run/asterisk/asterisk.pid'
        insertafter: '^\[directories\]'
        create: yes

    - name: Create Asterisk systemd service file
      template:
        src: templates/asterisk.service.j2
        dest: /etc/systemd/system/asterisk.service
        owner: root
        group: root
        mode: '0644'
      notify: reload systemd

    - name: Enable and start Asterisk service
      systemd:
        name: asterisk
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for Asterisk to start
      wait_for:
        port: 5060
        delay: 5
        timeout: 30

    - name: Display Asterisk version
      command: asterisk -V
      register: asterisk_version_output
      changed_when: false

    - name: Show Asterisk version
      debug:
        msg: "{{ asterisk_version_output.stdout }}"

    # Redis Installation and Configuration
    - name: Install Redis
      dnf:
        name: redis6
        state: present

    - name: Create Redis configuration directory
      file:
        path: /etc/redis6
        state: directory
        owner: redis
        group: redis
        mode: '0755'

    - name: Configure Redis
      template:
        src: templates/redis.conf.j2
        dest: /etc/redis6/redis6.conf
        owner: redis
        group: redis
        mode: '0640'
      notify: restart redis

    - name: Create Redis data directory
      file:
        path: /var/lib/redis6
        state: directory
        owner: redis
        group: redis
        mode: '0750'

    - name: Create Redis log directory
      file:
        path: /var/log/redis6
        state: directory
        owner: redis
        group: redis
        mode: '0755'

    - name: Create Redis PID directory
      file:
        path: /var/run/redis6
        state: directory
        owner: redis
        group: redis
        mode: '0755'

    - name: Enable and start Redis service
      systemd:
        name: redis6
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for Redis to start
      wait_for:
        port: 6379
        delay: 2
        timeout: 30

    - name: Test Redis connection
      command: redis-cli -a "{{ redis_password }}" ping
      register: redis_ping
      changed_when: false
      failed_when: redis_ping.stdout != "PONG"

    - name: Display Redis status
      debug:
        msg: "Redis is running and responding to commands"

  handlers:
    - name: restart redis
      systemd:
        name: redis6
        state: restarted

    - name: reload systemd
      systemd:
        daemon_reload: yes
