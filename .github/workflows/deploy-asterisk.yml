name: Deploy Asterisk Configuration to Servers

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'ansible/**'
      - 'src/asterisk-worker/**'
      - '.github/workflows/deploy-asterisk.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      playbook:
        description: 'Ansible playbook to run'
        required: true
        default: 'site.yml'
        type: choice
        options:
          - site.yml
          - asterisk-setup.yml
          - asterisk-configure.yml
          - nodejs-worker-deploy.yml
      skip_health_check:
        description: 'Skip health checks after deployment'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: il-central-1
  ANSIBLE_VERSION: '2.15'
  NODE_VERSION: '18'

jobs:
  validate-ansible:
    name: Validate Ansible Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install ansible-lint
      
      - name: Ansible Lint
        working-directory: ansible
        run: |
          ansible-lint *.yml || true
      
      - name: Validate Ansible Syntax
        working-directory: ansible
        run: |
          ansible-playbook --syntax-check site.yml
          ansible-playbook --syntax-check asterisk-setup.yml
          ansible-playbook --syntax-check asterisk-configure.yml
          ansible-playbook --syntax-check nodejs-worker-deploy.yml

  build-nodejs-worker:
    name: Build Node.js Worker
    runs-on: ubuntu-latest
    needs: validate-ansible
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/asterisk-worker/package.json
      
      - name: Install dependencies
        working-directory: src/asterisk-worker
        run: npm ci
      
      - name: Create deployment package
        working-directory: src/asterisk-worker
        run: |
          mkdir -p dist
          cp -r node_modules dist/
          cp index.js dist/
          cp package.json dist/
          cp extensions.conf dist/
          tar -czf asterisk-worker.tar.gz -C dist .
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: asterisk-worker
          path: src/asterisk-worker/asterisk-worker.tar.gz
          retention-days: 5

  deploy-asterisk:
    name: Deploy to Asterisk Servers
    runs-on: ubuntu-latest
    needs: [validate-ansible, build-nodejs-worker]
    
    permissions:
      id-token: write
      contents: read
    
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install boto3 botocore
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Node.js Worker artifact
        uses: actions/download-artifact@v3
        with:
          name: asterisk-worker
          path: /tmp/
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" > ~/.ssh/asterisk_key
          chmod 600 ~/.ssh/asterisk_key
          ssh-keyscan -H ${{ secrets.ASTERISK_HOST }} >> ~/.ssh/known_hosts || true
      
      - name: Get Asterisk server IPs from AWS
        id: get-servers
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          
          # Query EC2 instances with tag Environment=$ENV and Name=asterisk
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
          
          # Create dynamic inventory
          cat > ansible/inventory/dynamic_hosts.ini << EOF
          [asterisk]
          $(echo $INSTANCE_IPS | tr ' ' '\n')
          
          [asterisk:vars]
          ansible_user=ubuntu
          ansible_ssh_private_key_file=~/.ssh/asterisk_key
          ansible_python_interpreter=/usr/bin/python3
          environment=$ENV
          EOF
      
      - name: Copy Node.js Worker to deployment location
        run: |
          cp /tmp/asterisk-worker.tar.gz ansible/files/
      
      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          PLAYBOOK="${{ github.event.inputs.playbook || 'site.yml' }}"
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          
          ansible-playbook \
            -i inventory/dynamic_hosts.ini \
            -e "environment=$ENV" \
            -e "nodejs_worker_package=/tmp/asterisk-worker.tar.gz" \
            $PLAYBOOK
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
      
      - name: Restart Asterisk services
        working-directory: ansible
        run: |
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk state=restarted" \
            --become
          
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk-worker state=restarted" \
            --become
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

  health-check:
    name: Run Health Checks
    runs-on: ubuntu-latest
    needs: deploy-asterisk
    if: github.event.inputs.skip_health_check != 'true'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Asterisk server IPs
        id: get-servers
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
      
      - name: Wait for services to start
        run: sleep 30
      
      - name: Check Asterisk service status
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Checking Asterisk on $IP..."
            
            # Check if Asterisk is running
            ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no ubuntu@$IP \
              "sudo systemctl is-active asterisk" || exit 1
            
            # Check if Node.js worker is running
            ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no ubuntu@$IP \
              "sudo systemctl is-active asterisk-worker" || exit 1
            
            echo "âœ… Services running on $IP"
          done
      
      - name: Test AMI connection
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing AMI connection on $IP..."
            
            # Test AMI port (5038) is open
            timeout 5 bash -c "cat < /dev/null > /dev/tcp/$IP/5038" && echo "âœ… AMI port open on $IP" || echo "âŒ AMI port closed on $IP"
          done
      
      - name: Test Node.js Worker HTTP endpoint
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing Node.js Worker on $IP..."
            
            # Test HTTP endpoint (assuming port 3000)
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$IP:3000/health || echo "000")
            
            if [ "$RESPONSE" == "200" ]; then
              echo "âœ… Node.js Worker healthy on $IP"
            else
              echo "âŒ Node.js Worker unhealthy on $IP (HTTP $RESPONSE)"
              exit 1
            fi
          done
      
      - name: Test SIP trunk connectivity
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing SIP trunk on $IP..."
            
            # Check SIP registration status via AMI
            ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no ubuntu@$IP \
              "sudo asterisk -rx 'sip show registry'" || true
            
            echo "SIP status checked on $IP"
          done

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-ansible, build-nodejs-worker, deploy-asterisk, health-check]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Asterisk Deployment Summary ðŸ“ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Playbook:** ${{ github.event.inputs.playbook || 'site.yml' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-ansible.result }}" == "success" ]; then
            echo "âœ… Ansible validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Ansible validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-nodejs-worker.result }}" == "success" ]; then
            echo "âœ… Node.js Worker built" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Node.js Worker build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-asterisk.result }}" == "success" ]; then
            echo "âœ… Asterisk configuration deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Asterisk deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… Health checks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.health-check.result }}" == "skipped" ]; then
            echo "â­ï¸ Health checks skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health checks failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Asterisk telephony engine" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js AMI/ARI worker" >> $GITHUB_STEP_SUMMARY
          echo "- IVR dialplan configuration" >> $GITHUB_STEP_SUMMARY
