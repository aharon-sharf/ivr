name: Deploy Asterisk Configuration to Server

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'ansible/**'
      - 'src/asterisk-worker/**'
      - '.github/workflows/deploy-asterisk.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      playbook:
        description: 'Ansible playbook to run'
        required: true
        default: 'site.yml'
        type: choice
        options:
          - site.yml
          - asterisk-setup.yml
          - asterisk-configure.yml
          - nodejs-worker-deploy.yml
      skip_health_check:
        description: 'Skip health checks after deployment'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: il-central-1
  ANSIBLE_VERSION: '10.7.0'
  NODE_VERSION: '24'

jobs:
  validate-ansible:
    name: Validate Ansible Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install ansible-lint
      
      - name: Ansible Lint
        working-directory: ansible
        run: |
          ansible-lint *.yml || true
      
      - name: Validate Ansible Syntax
        working-directory: ansible
        run: |
          ansible-playbook --syntax-check site.yml
          ansible-playbook --syntax-check asterisk-setup.yml
          ansible-playbook --syntax-check asterisk-configure.yml
          ansible-playbook --syntax-check nodejs-worker-deploy.yml

  build-nodejs-worker:
    name: Build Node.js Worker
    runs-on: ubuntu-latest
    needs: validate-ansible
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Node.js Worker package
        run: |
          mkdir -p /tmp/asterisk-worker
          
          # Create basic Node.js worker structure
          cat > /tmp/asterisk-worker/package.json << 'EOF'
          {
            "name": "asterisk-worker",
            "version": "1.0.0",
            "description": "Node.js worker for Asterisk AMI/ARI integration",
            "main": "index.js",
            "engines": {
              "node": ">=24.0.0"
            },
            "scripts": {
              "start": "node index.js"
            },
            "dependencies": {
              "express": "^4.18.2",
              "asterisk-manager": "^0.1.16",
              "ari-client": "^2.2.0",
              "redis": "^4.6.5"
            }
          }
          EOF
          
          # Create basic worker script
          cat > /tmp/asterisk-worker/index.js << 'EOF'
          const express = require('express');
          const app = express();
          const port = process.env.PORT || 3000;
          
          app.use(express.json());
          
          // Health check endpoint
          app.get('/health', (req, res) => {
            res.json({ status: 'healthy', timestamp: new Date().toISOString() });
          });
          
          // Call started webhook
          app.post('/call-started', (req, res) => {
            console.log('Call started:', req.body);
            res.json({ status: 'received' });
          });
          
          // DTMF action webhook
          app.post('/dtmf-action', (req, res) => {
            console.log('DTMF action:', req.body);
            res.json({ status: 'processed' });
          });
          
          // Call timeout webhook
          app.post('/call-timeout', (req, res) => {
            console.log('Call timeout:', req.body);
            res.json({ status: 'logged' });
          });
          
          // Call ended webhook
          app.post('/call-ended', (req, res) => {
            console.log('Call ended:', req.body);
            res.json({ status: 'logged' });
          });
          
          // Call failed webhook
          app.post('/call-failed', (req, res) => {
            console.log('Call failed:', req.body);
            res.json({ status: 'logged' });
          });
          
          app.listen(port, () => {
            console.log(`Asterisk worker listening on port ${port}`);
          });
          EOF
          
          # Create systemd service file
          cat > /tmp/asterisk-worker/asterisk-worker.service << 'EOF'
          [Unit]
          Description=Asterisk Node.js Worker
          After=network.target asterisk.service
          
          [Service]
          Type=simple
          User=asterisk
          WorkingDirectory=/opt/asterisk-worker
          ExecStart=/usr/bin/node index.js
          Restart=always
          RestartSec=10
          Environment=NODE_ENV=production
          Environment=PORT=3000
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create deployment package
          cd /tmp/asterisk-worker
          tar -czf asterisk-worker.tar.gz *
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: asterisk-worker
          path: /tmp/asterisk-worker/asterisk-worker.tar.gz
          retention-days: 5

  determine-environment:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    needs: [validate-ansible, build-nodejs-worker]
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
    
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy-asterisk-dev:
    name: Deploy to Asterisk Servers (Dev)
    runs-on: ubuntu-latest
    needs: determine-environment
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    
    permissions:
      id-token: write
      contents: read
    
    environment:
      name: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install boto3 botocore
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Node.js Worker artifact
        uses: actions/download-artifact@v4
        with:
          name: asterisk-worker
          path: /tmp/
      
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" ]; then
            echo "Error: ASTERISK_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_DEPLOY_ROLE_ARN }}" ]; then
            echo "Error: AWS_DEPLOY_ROLE_ARN secret is not set"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" > ~/.ssh/asterisk_key
          chmod 600 ~/.ssh/asterisk_key
      
      - name: Get Asterisk server IPs from AWS
        id: get-servers
        run: |
          ENV="dev"
          
          # Debug: Show all instances first
          echo "Searching for instances with Environment=$ENV and Name containing 'asterisk'"
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],PublicIpAddress,State.Name]' \
            --output table
          
          # Query EC2 instances with tag Environment=$ENV and Name contains asterisk
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=*asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "Found instance IPs: $INSTANCE_IPS"
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
          
          if [ -z "$INSTANCE_IPS" ]; then
            echo "No Asterisk instances found for environment: $ENV"
            echo "Make sure your EC2 instances have the correct tags:"
            echo "- Environment: $ENV"
            echo "- Name: should contain 'asterisk'"
            exit 1
          fi
          
          # Create dynamic inventory
          cat > ansible/inventory/dynamic_hosts.ini << EOF
          [asterisk]
          $(echo $INSTANCE_IPS | tr ' ' '\n')
          
          [asterisk:vars]
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/asterisk_key
          ansible_python_interpreter=/usr/bin/python3
          environment=$ENV
          EOF
      
      - name: Copy Node.js Worker to deployment location
        run: |
          mkdir -p ansible/files
          cp /tmp/asterisk-worker.tar.gz ansible/files/
          ls -la ansible/files/
      
      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          PLAYBOOK="${{ github.event.inputs.playbook || 'site.yml' }}"
          ENV="dev"
          
          ansible-playbook \
            -i inventory/dynamic_hosts.ini \
            -e "environment=$ENV" \
            -e "nodejs_worker_package=files/asterisk-worker.tar.gz" \
            -v \
            $PLAYBOOK
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
      
      - name: Restart Asterisk services
        working-directory: ansible
        run: |
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk state=restarted" \
            --become
          
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk-worker state=restarted" \
            --become
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

  deploy-asterisk-staging:
    name: Deploy to Asterisk Servers (Staging)
    runs-on: ubuntu-latest
    needs: determine-environment
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    permissions:
      id-token: write
      contents: read
    
    environment:
      name: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install boto3 botocore
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Node.js Worker artifact
        uses: actions/download-artifact@v4
        with:
          name: asterisk-worker
          path: /tmp/
      
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" ]; then
            echo "Error: ASTERISK_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_DEPLOY_ROLE_ARN }}" ]; then
            echo "Error: AWS_DEPLOY_ROLE_ARN secret is not set"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" > ~/.ssh/asterisk_key
          chmod 600 ~/.ssh/asterisk_key
      
      - name: Get Asterisk server IPs from AWS
        id: get-servers
        run: |
          ENV="staging"
          
          # Debug: Show all instances first
          echo "Searching for instances with Environment=$ENV and Name containing 'asterisk'"
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],PublicIpAddress,State.Name]' \
            --output table
          
          # Query EC2 instances with tag Environment=$ENV and Name contains asterisk
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=*asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "Found instance IPs: $INSTANCE_IPS"
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
          
          if [ -z "$INSTANCE_IPS" ]; then
            echo "No Asterisk instances found for environment: $ENV"
            echo "Make sure your EC2 instances have the correct tags:"
            echo "- Environment: $ENV"
            echo "- Name: should contain 'asterisk'"
            exit 1
          fi
          
          # Create dynamic inventory
          cat > ansible/inventory/dynamic_hosts.ini << EOF
          [asterisk]
          $(echo $INSTANCE_IPS | tr ' ' '\n')
          
          [asterisk:vars]
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/asterisk_key
          ansible_python_interpreter=/usr/bin/python3
          environment=$ENV
          EOF
      
      - name: Copy Node.js Worker to deployment location
        run: |
          mkdir -p ansible/files
          cp /tmp/asterisk-worker.tar.gz ansible/files/
          ls -la ansible/files/
      
      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          PLAYBOOK="${{ github.event.inputs.playbook || 'site.yml' }}"
          ENV="staging"
          
          ansible-playbook \
            -i inventory/dynamic_hosts.ini \
            -e "environment=$ENV" \
            -e "nodejs_worker_package=files/asterisk-worker.tar.gz" \
            -v \
            $PLAYBOOK
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
      
      - name: Restart Asterisk services
        working-directory: ansible
        run: |
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk state=restarted" \
            --become
          
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk-worker state=restarted" \
            --become
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

  deploy-asterisk-production:
    name: Deploy to Asterisk Servers (Production)
    runs-on: ubuntu-latest
    needs: determine-environment
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    
    permissions:
      id-token: write
      contents: read
    
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible==${{ env.ANSIBLE_VERSION }}
          pip install boto3 botocore
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Download Node.js Worker artifact
        uses: actions/download-artifact@v4
        with:
          name: asterisk-worker
          path: /tmp/
      
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" ]; then
            echo "Error: ASTERISK_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_DEPLOY_ROLE_ARN }}" ]; then
            echo "Error: AWS_DEPLOY_ROLE_ARN secret is not set"
            exit 1
          fi
          echo "All required secrets are present"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ASTERISK_SSH_PRIVATE_KEY }}" > ~/.ssh/asterisk_key
          chmod 600 ~/.ssh/asterisk_key
      
      - name: Get Asterisk server IPs from AWS
        id: get-servers
        run: |
          ENV="production"
          
          # Debug: Show all instances first
          echo "Searching for instances with Environment=$ENV and Name containing 'asterisk'"
          aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].[InstanceId,Tags[?Key==`Name`].Value|[0],PublicIpAddress,State.Name]' \
            --output table
          
          # Query EC2 instances with tag Environment=$ENV and Name contains asterisk
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=*asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "Found instance IPs: $INSTANCE_IPS"
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
          
          if [ -z "$INSTANCE_IPS" ]; then
            echo "No Asterisk instances found for environment: $ENV"
            echo "Make sure your EC2 instances have the correct tags:"
            echo "- Environment: $ENV"
            echo "- Name: should contain 'asterisk'"
            exit 1
          fi
          
          # Create dynamic inventory
          cat > ansible/inventory/dynamic_hosts.ini << EOF
          [asterisk]
          $(echo $INSTANCE_IPS | tr ' ' '\n')
          
          [asterisk:vars]
          ansible_user=ec2-user
          ansible_ssh_private_key_file=~/.ssh/asterisk_key
          ansible_python_interpreter=/usr/bin/python3
          environment=$ENV
          EOF
      
      - name: Copy Node.js Worker to deployment location
        run: |
          mkdir -p ansible/files
          cp /tmp/asterisk-worker.tar.gz ansible/files/
          ls -la ansible/files/
      
      - name: Run Ansible Playbook
        working-directory: ansible
        run: |
          PLAYBOOK="${{ github.event.inputs.playbook || 'site.yml' }}"
          ENV="production"
          
          ansible-playbook \
            -i inventory/dynamic_hosts.ini \
            -e "environment=$ENV" \
            -e "nodejs_worker_package=files/asterisk-worker.tar.gz" \
            -v \
            $PLAYBOOK
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
      
      - name: Restart Asterisk services
        working-directory: ansible
        run: |
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk state=restarted" \
            --become
          
          ansible asterisk \
            -i inventory/dynamic_hosts.ini \
            -m systemd \
            -a "name=asterisk-worker state=restarted" \
            --become
        env:
          ANSIBLE_HOST_KEY_CHECKING: False

  health-check:
    name: Run Health Checks
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy-asterisk-dev, deploy-asterisk-staging, deploy-asterisk-production]
    if: |
      always() && 
      (needs.deploy-asterisk-dev.result == 'success' || needs.deploy-asterisk-staging.result == 'success' || needs.deploy-asterisk-production.result == 'success') &&
      github.event.inputs.skip_health_check != 'true'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Get Asterisk server IPs
        id: get-servers
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --region ${{ env.AWS_REGION }} \
            --filters "Name=tag:Environment,Values=$ENV" "Name=tag:Name,Values=*asterisk*" "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PublicIpAddress' \
            --output text)
          
          echo "instance_ips=$INSTANCE_IPS" >> $GITHUB_OUTPUT
      
      - name: Wait for services to start
        run: sleep 30
      
      - name: Check Asterisk service status
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Checking Asterisk on $IP..."
            
            # Check if Asterisk is running with retry
            for i in {1..3}; do
              if ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ec2-user@$IP \
                "sudo systemctl is-active asterisk"; then
                echo "‚úÖ Asterisk is running on $IP"
                break
              else
                echo "Attempt $i failed, retrying..."
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "‚ùå Asterisk is not running on $IP after 3 attempts"
                  exit 1
                fi
              fi
            done
            
            # Check if Node.js worker is running with retry
            for i in {1..3}; do
              if ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ec2-user@$IP \
                "sudo systemctl is-active asterisk-worker"; then
                echo "‚úÖ Node.js worker is running on $IP"
                break
              else
                echo "Node.js worker attempt $i failed, retrying..."
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "‚ö†Ô∏è Node.js worker is not running on $IP (this might be expected if not deployed yet)"
                fi
              fi
            done
            
            echo "‚úÖ Health check completed for $IP"
          done
      
      - name: Test AMI connection
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing AMI connection on $IP..."
            
            # Test AMI port (5038) is open
            timeout 5 bash -c "cat < /dev/null > /dev/tcp/$IP/5038" && echo "‚úÖ AMI port open on $IP" || echo "‚ùå AMI port closed on $IP"
          done
      
      - name: Test Node.js Worker HTTP endpoint
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing Node.js Worker on $IP..."
            
            # Test HTTP endpoint (assuming port 3000)
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$IP:3000/health || echo "000")
            
            if [ "$RESPONSE" == "200" ]; then
              echo "‚úÖ Node.js Worker healthy on $IP"
            else
              echo "‚ùå Node.js Worker unhealthy on $IP (HTTP $RESPONSE)"
              exit 1
            fi
          done
      
      - name: Test SIP trunk connectivity
        run: |
          for IP in ${{ steps.get-servers.outputs.instance_ips }}; do
            echo "Testing SIP trunk on $IP..."
            
            # Check SIP registration status via AMI
            ssh -i ~/.ssh/asterisk_key -o StrictHostKeyChecking=no ec2-user@$IP \
              "sudo asterisk -rx 'pjsip show registrations'" || true
            
            echo "SIP status checked on $IP"
          done

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-ansible, build-nodejs-worker, determine-environment, deploy-asterisk-dev, deploy-asterisk-staging, deploy-asterisk-production, health-check]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Asterisk Deployment Summary üìû" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Playbook:** ${{ github.event.inputs.playbook || 'site.yml' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-ansible.result }}" == "success" ]; then
            echo "‚úÖ Ansible validation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Ansible validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-nodejs-worker.result }}" == "success" ]; then
            echo "‚úÖ Node.js Worker built" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Node.js Worker build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check deployment results based on environment
          if [ "${{ needs.deploy-asterisk-dev.result }}" == "success" ]; then
            echo "‚úÖ Asterisk configuration deployed to dev" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-asterisk-staging.result }}" == "success" ]; then
            echo "‚úÖ Asterisk configuration deployed to staging" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-asterisk-production.result }}" == "success" ]; then
            echo "‚úÖ Asterisk configuration deployed to production" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-asterisk-dev.result }}" == "failure" ] || [ "${{ needs.deploy-asterisk-staging.result }}" == "failure" ] || [ "${{ needs.deploy-asterisk-production.result }}" == "failure" ]; then
            echo "‚ùå Asterisk deployment failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è Asterisk deployment skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "‚úÖ Health checks passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.health-check.result }}" == "skipped" ]; then
            echo "‚è≠Ô∏è Health checks skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Health checks failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Asterisk telephony engine" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js AMI/ARI worker" >> $GITHUB_STEP_SUMMARY
          echo "- IVR dialplan configuration" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Flow" >> $GITHUB_STEP_SUMMARY
          echo "- **develop** branch ‚Üí auto-deploy to **dev**" >> $GITHUB_STEP_SUMMARY
          echo "- **main** branch ‚Üí auto-deploy to **staging**" >> $GITHUB_STEP_SUMMARY
          echo "- **production** ‚Üí manual deployment only (workflow_dispatch)" >> $GITHUB_STEP_SUMMARY
