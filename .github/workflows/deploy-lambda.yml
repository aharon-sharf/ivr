name: Deploy Lambda Functions

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/lambda/**'
      - 'src/models/**'
      - 'src/types/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      functions:
        description: 'Comma-separated list of functions to deploy (leave empty for all)'
        required: false
        type: string

env:
  AWS_REGION: il-central-1
  NODE_VERSION: '18'
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.il-central-1.amazonaws.com

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test
        env:
          CI: true
      
      - name: Run property-based tests
        run: npm run test
        env:
          CI: true
      
      - name: Generate test coverage
        run: npm run test:coverage
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella

  build-and-deploy:
    name: Build and Deploy Lambda Functions
    runs-on: ubuntu-latest
    needs: test
    
    permissions:
      id-token: write
      contents: read
    
    strategy:
      matrix:
        function:
          - api-handler
          - dispatcher
          - dialer-worker
          - enrich-dial-task
          - validate-campaign
          - status-checker
          - campaign-orchestrator
          - sms-gateway
          - sms-dispatcher
          - sms-reply-handler
          - tts-service
          - tts-fallback
          - ml-inference
          - analytics
          - report-generator
          - campaign-comparison
          - cdr-logger
          - donation-handler
          - optout-handler
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if function should be deployed
        id: should-deploy
        run: |
          FUNCTIONS_INPUT="${{ github.event.inputs.functions }}"
          FUNCTION_NAME="${{ matrix.function }}"
          
          if [ -z "$FUNCTIONS_INPUT" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          elif echo "$FUNCTIONS_INPUT" | grep -q "$FUNCTION_NAME"; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Configure AWS credentials
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        if: steps.should-deploy.outputs.deploy == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        if: steps.should-deploy.outputs.deploy == 'true'
        working-directory: src/lambda/${{ matrix.function }}
        run: |
          # Check if Dockerfile exists
          if [ ! -f Dockerfile ]; then
            echo "No Dockerfile found for ${{ matrix.function }}, skipping..."
            exit 0
          fi
          
          # Build image
          docker build -t ${{ matrix.function }}:${{ github.sha }} .
          docker tag ${{ matrix.function }}:${{ github.sha }} ${{ env.ECR_REGISTRY }}/${{ matrix.function }}:${{ github.sha }}
          docker tag ${{ matrix.function }}:${{ github.sha }} ${{ env.ECR_REGISTRY }}/${{ matrix.function }}:latest
      
      - name: Push Docker image to ECR
        if: steps.should-deploy.outputs.deploy == 'true'
        run: |
          # Check if image was built
          if docker images | grep -q "${{ matrix.function }}"; then
            docker push ${{ env.ECR_REGISTRY }}/${{ matrix.function }}:${{ github.sha }}
            docker push ${{ env.ECR_REGISTRY }}/${{ matrix.function }}:latest
          else
            echo "No image to push for ${{ matrix.function }}"
          fi
      
      - name: Update Lambda function code
        if: steps.should-deploy.outputs.deploy == 'true'
        run: |
          # Get environment suffix
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${{ matrix.function }}-${ENV}"
          
          # Update Lambda function with new image
          aws lambda update-function-code \
            --function-name $FUNCTION_NAME \
            --image-uri ${{ env.ECR_REGISTRY }}/${{ matrix.function }}:${{ github.sha }} \
            --region ${{ env.AWS_REGION }} || echo "Function $FUNCTION_NAME not found, skipping..."
          
          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name $FUNCTION_NAME \
            --region ${{ env.AWS_REGION }} || true
      
      - name: Run smoke tests
        if: steps.should-deploy.outputs.deploy == 'true'
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          FUNCTION_NAME="${{ matrix.function }}-${ENV}"
          
          # Invoke function with test payload
          aws lambda invoke \
            --function-name $FUNCTION_NAME \
            --payload '{"test": true}' \
            --region ${{ env.AWS_REGION }} \
            response.json || echo "Smoke test failed for $FUNCTION_NAME"
          
          # Check response
          if [ -f response.json ]; then
            cat response.json
          fi

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run integration tests
        run: |
          # Set environment variables for integration tests
          export AWS_REGION=${{ env.AWS_REGION }}
          export ENVIRONMENT="${{ github.event.inputs.environment || 'dev' }}"
          
          # Run integration tests (if they exist)
          if [ -d "tests/integration" ]; then
            npm run test -- tests/integration
          else
            echo "No integration tests found, skipping..."
          fi
        env:
          CI: true

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [test, build-and-deploy, integration-tests]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Lambda Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
            echo "âœ… Lambda functions deployed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lambda deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "âœ… Integration tests passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-tests.result }}" == "skipped" ]; then
            echo "â­ï¸ Integration tests skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration tests failed" >> $GITHUB_STEP_SUMMARY
          fi
