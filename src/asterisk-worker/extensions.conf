;
; Asterisk Dialplan for Mass Voice Campaign System
; This dialplan handles IVR logic for voice campaigns
;
; Requirements: 4.1, 4.2, 4.4, 4.6
;

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; Node.js Worker URL for callbacks
NODEJS_WORKER_URL=http://localhost:3000

; ===== Incoming calls from SIP trunk =====
[from-trunk]
exten => _X.,1,NoOp(Incoming call from trunk: ${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Goto(ivr-main,s,1)

; ===== Main IVR Menu =====
; This context plays the campaign audio and waits for DTMF input
[ivr-main]
exten => s,1,NoOp(Starting IVR for campaign ${CAMPAIGN_ID})
 ; Set DTMF timeouts
 same => n,Set(TIMEOUT(digit)=5)        ; 5 seconds between digits
 same => n,Set(TIMEOUT(response)=10)    ; 10 seconds to start input
 ; Initialize call tracking variables
 same => n,Set(CALL_ID=${UNIQUEID})
 same => n,Set(DTMF_INPUTS=)
 ; Notify Node.js worker that call started
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/call-started,call_id=${CALL_ID}&phone=${CALLERID(num)}&campaign_id=${CAMPAIGN_ID})})
 ; Play audio message from S3 or local file
 ; AUDIO_FILE variable is set by the originate command
 same => n,Playback(${AUDIO_FILE})
 ; Wait for DTMF input
 same => n,Goto(ivr-wait-input,s,1)

; ===== Wait for DTMF input =====
; This context captures a single DTMF digit with timeout
[ivr-wait-input]
exten => s,1,NoOp(Waiting for DTMF input)
 ; Read single digit with 10 second timeout
 same => n,Read(DTMF_INPUT,,1,,10,)
 ; Check if timeout (no input)
 same => n,GotoIf($["${DTMF_INPUT}" = ""]?timeout)
 ; Store DTMF input
 same => n,Set(DTMF_INPUTS=${DTMF_INPUTS}${DTMF_INPUT})
 ; Process the DTMF digit
 same => n,Goto(process-dtmf,${DTMF_INPUT},1)
 ; Handle timeout
 same => n(timeout),Goto(ivr-timeout,s,1)

; ===== Process DTMF Input =====
; This context handles different DTMF actions based on the digit pressed
[process-dtmf]

; Press 1 - Donation/Transfer to agent
; Requirement 4.2: Execute configured action for DTMF 1
exten => 1,1,NoOp(User pressed 1 - Donation action)
 ; Notify Node.js worker to trigger donation flow
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/dtmf-action,call_id=${CALL_ID}&dtmf=1&action=donation)})
 ; Play thank you message
 same => n,Playback(thank-you-donation)
 ; End call
 same => n,Hangup()

; Press 2 - More information (example)
; This can be customized per campaign
exten => 2,1,NoOp(User pressed 2 - More info)
 ; Notify Node.js worker
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/dtmf-action,call_id=${CALL_ID}&dtmf=2&action=info)})
 ; Play additional information
 same => n,Playback(more-info)
 ; Return to main menu
 same => n,Goto(ivr-wait-input,s,1)

; Press 3 - Transfer to agent (example)
exten => 3,1,NoOp(User pressed 3 - Transfer to agent)
 ; Notify Node.js worker
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/dtmf-action,call_id=${CALL_ID}&dtmf=3&action=transfer)})
 ; Play transfer message
 same => n,Playback(transferring)
 ; Transfer to agent queue (example)
 ; same => n,Queue(support-queue)
 same => n,Hangup()

; Press 9 - Opt-out (add to blacklist)
; Requirement 4.3: Add to blacklist and terminate call
exten => 9,1,NoOp(User pressed 9 - Opt-out)
 ; Notify Node.js worker to add to blacklist
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/dtmf-action,call_id=${CALL_ID}&dtmf=9&action=optout&phone=${CALLERID(num)})})
 ; Play opt-out confirmation
 same => n,Playback(optout-confirmed)
 ; Terminate call immediately
 same => n,Hangup()

; Press 0 - Repeat menu (example)
exten => 0,1,NoOp(User pressed 0 - Repeat menu)
 ; Return to main menu
 same => n,Goto(ivr-main,s,1)

; Invalid input - any other digit
; Requirement 4.4: Handle invalid DTMF input
exten => _X,1,NoOp(Invalid DTMF: ${EXTEN})
 ; Play error message
 same => n,Playback(invalid-option)
 ; Repeat menu options
 same => n,Playback(please-try-again)
 ; Return to wait for input
 same => n,Goto(ivr-wait-input,s,1)

; ===== Timeout Handler =====
; Requirement 4.6: Handle no DTMF input within timeout period
[ivr-timeout]
exten => s,1,NoOp(No DTMF input received - timeout)
 ; Notify Node.js worker of timeout
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/call-timeout,call_id=${CALL_ID})})
 ; Play timeout message
 same => n,Playback(goodbye)
 ; End call
 same => n,Hangup()

; ===== Outbound Call Context =====
; This context is used for originating outbound campaign calls
; Requirement 4.1: Play pre-recorded audio on answer
[outbound-campaign]
exten => _X.,1,NoOp(Outbound call to ${EXTEN})
 ; Set caller ID from campaign configuration
 same => n,Set(CALLERID(num)=${CAMPAIGN_CALLER_ID})
 ; Set call ID for tracking
 same => n,Set(CALL_ID=${UNIQUEID})
 ; Dial the number via SIP trunk
 ; Will use {{ sip_trunk_provider }}-trunk from Ansible
 same => n,Dial(PJSIP/${EXTEN}@{{ sip_trunk_provider }}-trunk,30,g)
 ; Check dial status
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?answered:not-answered)
 ; Call was answered - go to IVR
 same => n(answered),Goto(ivr-main,s,1)
 ; Call was not answered
 same => n(not-answered),NoOp(Call not answered: ${DIALSTATUS})
 ; Notify Node.js worker of failure
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/call-failed,call_id=${CALL_ID}&status=${DIALSTATUS})})
 ; End call
 same => n,Hangup()

; ===== Hangup Handler =====
; This handler is called when any call ends
[hangup-handler]
exten => h,1,NoOp(Call ended: ${CALL_ID})
 ; Notify Node.js worker that call ended
 same => n,Set(CURL_RESULT=${CURL(${NODEJS_WORKER_URL}/call-ended,call_id=${CALL_ID}&duration=${CDR(duration)}&status=${DIALSTATUS})})
 same => n,Return()

; ===== Multi-Level Menu Example =====
; This is an example of a multi-level IVR menu
; Requirement 4.5: Navigate through menu hierarchies
[ivr-submenu]
exten => s,1,NoOp(Entering submenu)
 ; Play submenu options
 same => n,Playback(submenu-options)
 ; Wait for input
 same => n,Read(SUBMENU_INPUT,,1,,10,)
 ; Process submenu input
 same => n,GotoIf($["${SUBMENU_INPUT}" = "1"]?option1)
 same => n,GotoIf($["${SUBMENU_INPUT}" = "2"]?option2)
 same => n,GotoIf($["${SUBMENU_INPUT}" = "9"]?back)
 ; Invalid input
 same => n,Playback(invalid-option)
 same => n,Goto(s,1)
 ; Submenu options
 same => n(option1),Playback(submenu-option1)
 same => n,Goto(ivr-main,s,1)
 same => n(option2),Playback(submenu-option2)
 same => n,Goto(ivr-main,s,1)
 ; Go back to main menu
 same => n(back),Goto(ivr-main,s,1)

; ===== Emergency/Test Context =====
; For testing and emergency calls
[emergency]
exten => 911,1,NoOp(Emergency call)
 same => n,Playback(emergency-services)
 same => n,Hangup()

exten => test,1,NoOp(Test call)
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; ===== End of Dialplan =====
